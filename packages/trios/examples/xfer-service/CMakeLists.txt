INCLUDE(TribitsAddExecutable)
INCLUDE(TribitsAddTest)
INCLUDE(TribitsAddOptionAndDefine)
INCLUDE(TriosProcessXDR)

############# Special exception for rpcgen extra commas in enum ##########
IF (CMAKE_COMPILER_IS_GNUCXX)
  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fpermissive")
  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -isystem ${CMAKE_CURRENT_BINARY_DIR}")
  SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -isystem ${CMAKE_CURRENT_BINARY_DIR}")
ENDIF (CMAKE_COMPILER_IS_GNUCXX)

INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})


# We want the binary directory to be a system directory because it contains
# code generated by rpcgen, may have many warnings. 
#INCLUDE_DIRECTORIES(SYSTEM ${CMAKE_CURRENT_BINARY_DIR})

# Generate the XDR header and source file for the service arguments
TriosProcessXDR(${CMAKE_CURRENT_SOURCE_DIR}/xfer_service_args.x)


TRIBITS_ADD_EXECUTABLE(
  XferMPITest
  SOURCES xfer_service_args.c xfer_util.cpp xfer_mpi_server.cpp xfer_mpi_test.cpp xfer_mpi_client.cpp
  DEPLIBS ${DEPLIBS}
)


TRIBITS_ADD_EXECUTABLE(
  XferServiceTest
  SOURCES xfer_service_args.c xfer_util.cpp xfer_server.cpp xfer_service_test.cpp xfer_client.cpp
  DEPLIBS ${DEPLIBS}
)

SET(EXTRA_TEST_ARGS "")

# Gemini network transport takes a few seconds to initialize
IF (${PACKAGE_NAME}_ENABLE_Gemini)
  APPEND_SET(EXTRA_TEST_ARGS "--delay=3")
ENDIF()


SET(TESTNAMES 
   write-encode-sync
   write-encode-async
   write-rdma-sync
   write-rdma-async
   read-encode-sync
   read-encode-async
   read-rdma-sync
   read-rdma-async)


foreach (testname ${TESTNAMES})
  
  SET(DEFAULT_ARGS "--io-method=${testname} ")
  SET(DEFAULT_ARGS "${DEFAULT_ARGS} --result-file=${testname}-result.out ")
  SET(DEFAULT_ARGS "${DEFAULT_ARGS} --result-file-mode=a ")
  SET(DEFAULT_ARGS "${DEFAULT_ARGS} --num-trials=5 ")
  
  TRIBITS_ADD_TEST(
    XferServiceTest
    NAME XferService_${testname}
    ARGS "${DEFAULT_ARGS} ${EXTRA_TEST_ARGS}"
    COMM serial mpi
    NUM_MPI_PROCS 2)
  
  #SET_TESTS_PROPERTIES(${PACKAGE_NAME}_XferService_${testname}_MPI_2 PROPERTIES TIMEOUT 10)
endforeach()

    
