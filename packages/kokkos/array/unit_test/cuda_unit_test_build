#!/bin/csh

#-----------------------------------------------------------------------------
# Quick and dirty build for unit testing with Host (serial) and TPI devices.
# To be replace with CMake integration.

set HWLOC_PATH="/home/sems/common/hwloc/current"

set INC_PATH="-I. -I../src -I../TPL -I${HWLOC_PATH}/include"

set GCC_SOURCES="../src/impl/*.cpp"
set GCC_SOURCES="${GCC_SOURCES} ../src/Host/KokkosArray_Host_Impl.cpp"
set GCC_SOURCES="${GCC_SOURCES} ../src/Host/KokkosArray_Host_pthread.cpp"
set GCC_SOURCES="${GCC_SOURCES} ../src/Host/KokkosArray_Host_hwloc.cpp"
set GCC_SOURCES="${GCC_SOURCES} ../src/Host/KokkosArray_Host_MemoryManager.cpp"
set GCC_SOURCES="${GCC_SOURCES} UnitTestMain.cpp TestHost.cpp TestCuda.cpp"
set GCC_SOURCES="${GCC_SOURCES} ../TPL/gtest/gtest-all.cc"

set LIB="-lpthread -L${HWLOC_PATH}/lib -lhwloc"

#-----------------------------------------------------------------------------

set NVCC_SOURCES="../src/Cuda/*.cu"
set NVCC_SOURCES="${NVCC_SOURCES} TestCudaFunctions.cu"

set LIB="${LIB} -L/usr/local/cuda/lib64 libCuda.a -lcudart -lcuda"

set NVCC_FLAGS="-arch=sm_20 -g ${INC_PATH} -lib -o libCuda.a"

echo "nvcc ${NVCC_FLAGS} ${NVCC_SOURCES}"
nvcc ${NVCC_FLAGS} ${NVCC_SOURCES}

#-----------------------------------------------------------------------------

# set GCC_FLAGS="-ansi -Wall -Werror -O3 ${INC_PATH}"
set GCC_FLAGS="-ansi -Wall -Werror -g ${INC_PATH}"

g++ $GCC_FLAGS -c ${GCC_SOURCES}

g++ $GCC_FLAGS -o unit_test.exe *.o ${LIB}

rm -f *.o *.a 

#-----------------------------------------------------------------------------

